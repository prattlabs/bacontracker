<!DOCTYPE html>
<html ng-app="bacontracker">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Issues</title>
  <script>
    $(function() {
      $(".column").sortable({
        items : '.issue',
        connectWith: ".column",
        handle: ".draggable",
        cancel: ".portlet-toggle",
        placeholder: "portlet-placeholder ui-corner-all",
        update: function(event, ui) {
          var data = $(this).sortable('serialize');
          data = "state=" + $(this).attr('id') + "&" + data;

          // Need to staggar updates by a few hundred ms so that we don't get a race condition
          window.setTimeout(function(){
          $.ajax({
            data: data,
            type: 'PUT',
            url: 'api/issues/updateOrder?pname=' + $('#pname').text()
          })}, ($(this).attr('id').substr($(this).attr('id').length - 1) + 1) * 100
          );
        }
      });

      $(".portlet")
        .addClass("ui-widget ui-widget-content ui-helper-clearfix ui-corner-all")
        .find(".portlet-header")
        .addClass("ui-widget-header ui-corner-all")
        .prepend("<span class='ui-icon ui-icon-minusthick portlet-toggle'></span>");

      $(".portlet-toggle").on("click", function() {
        var icon = $(this);
        icon.toggleClass("ui-icon-minusthick ui-icon-plusthick");
        icon.closest(".portlet").find(".portlet-content").toggle();
      });
    });
    $(document).ready(function() {
      $('[data-toggle="popover"]').popover();
    });
    $("#editclear").click(function() {
      $("#editinput").val('');
    });
  </script>
</head>

<body ng-controller="IssueController as ctrl">
  <div class="container-fluid">
    <nav class="navbar navbar-light bg-faded">
      <button class="navbar-toggler hidden-sm-up" type="button" data-toggle="collapse" data-target="#exCollapsingNavbar2" aria-controls="exCollapsingNavbar2" aria-expanded="false" aria-label="Toggle navigation"></button>
      <div class="collapse navbar-toggleable-xs">
        <a id="logo" class="navbar-brand" href="/projects">Bacon Tracker<span><img src="../assets/img/bacon-logo.png"></span></a>
        <ul class="nav navbar-nav">
          <li class="nav-item active">
            <a class="nav-link" href="/projects">Projects<span class="sr-only">(current)</span></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Account</a>
          </li>

        </ul>
        <div class="nav-item dropdown">
          <a class="nav-link dropdown-toggle account-name-nav" href="#" data-toggle="dropdown">Cameron Lengerich</a>
          <div class="dropdown-menu">
            <a class="dropdown-item" href="/api/logout">Logout</a>
          </div>
        </div>
      </div>
    </nav>
    <br>

    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
      <h2 id="pname" class="header">{{project.name}}</h2>
      <!-- Search Box -->
      <input type="text" class="form-control issue-search" ng-model="filter" placeholder="Filter: issue, author">
    </div>
    <div class="col-md-12">
      <input class="btn btn-danger create-btn" type="button" name="Create" data-toggle="modal" data-target="#editIssue"
             ng-click="createIssue();" value="Create">
    </div>

    <!-- Issues -->
    <div class="column header col-xs-4 col-sm-4 col-md-4 col-lg-4" id="issueState_{{$index}}" ng-repeat="state in ['Open', 'In Progress', 'Closed']"><h3>{{state}}</h3>
      <div class="portlet card issue" id="issueOrder_{{issue._id}}" ng-repeat="issue in issues | filter:filter | filter:{state:$index}">
        <div class="portlet-header card-header draggable">
          <a href="#" data-toggle="modal" data-target="#editIssue" ng-click="setIssue(issue)"><b>{{issue.title}}</b></a>
        </div>
        <div class="portlet-content card-text draggable">
          <p>{{issue.description}}</p>
          <p class="assignee blockquote"><a href="#">{{issue.assignee}}</a></p>
        </div>
      </div>
    </div>

    <!-- Edit Issue Modal Window -->
    <div id="editIssue" class="modal fade" role="dialog">
      <div class="modal-dialog modal-lg">
        <!-- Modal content-->
        <div class="modal-content">
          <form name="editForm">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal">&times;</button>
              <span>Title: </span><input class="form-control" type="text" ng-model="issue.title" ng-change="log(issue)" required />
            </div>
            <div class="modal-body">
              <span>Description:</span><input class="form-control" type="text" ng-model="issue.description" ng-change="log(issue)" required />
              <span>Assignee:</span><input class="form-control" type="text" ng-model="issue.assignee" ng-change="log(issue)" />
              <table>
              <tr>
                <td>Number:&nbsp;</td>
                <td><span class="tag tag-info">{{issue.number}}</span><br></td>
              </tr>
              <tr>
                <td>State:</td>
                <td><span class="tag tag-success">{{issue.state}}</span></td>
              </tr>
            </table>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-info" ng-click="this.editForm.$valid && saveIssue(issue)">Save and Close</button>
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              <button type="button" class="btn btn-danger delete-btn" ng-click="deleteIssue(issue)">Delete</button>
            </div>
          </form>
        </div>
      </div>
    </div>

  </div>
</body>
<footer>
  <script src="app.js" type="text/javascript"></script>
</footer>

</html>
